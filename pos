#!/bin/bash

if [ ! -d "${HOME}/personal-os-data" ]; then
    mkdir -p "${HOME}/personal-os-data"
    echo "Created ${HOME}/personal-os-data"
fi

if [ ! -d "${HOME}/personal-os-data/.git" ]; then
    git -C "${HOME}/personal-os-data" init
    echo "Initialized git repo in ${HOME}/personal-os-data"
fi

# Check if personal-os-data is empty (no files except .git)
DATA_FILES=$(find "${HOME}/personal-os-data" -mindepth 1 -maxdepth 1 ! -name '.git' | head -1)
[ -z "$DATA_FILES" ] && ONBOARDING_MODE=true || ONBOARDING_MODE=false

claude \
    --model opus \
    --allowedTools '*' \
    --allow-dangerously-skip-permissions \
    --dangerously-skip-permissions \
    --add-dir "${HOME}/personal-os-data" \
    --add-dir "${HOME}" \
    --mcp-config '{"mcpServers": {"chrome-devtools": {"command": "npx", "args": ["-y", "chrome-devtools-mcp@latest", "--autoConnect", "--user-data-dir", "${HOME}/personal-os-chrome-data"]}}}' \
    --append-system-prompt '
## Browser Tips

- Launch Chrome: `/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --remote-debugging-port=9222 --user-data-dir="$HOME/personal-os-chrome-data" &`
- Restart Chrome: `osascript -e '\''quit app "Google Chrome"'\'' && sleep 2`, then run launch command
- Check port: `lsof -i :9222`
- Fix DevToolsActivePort: `curl -s http://localhost:9222/json/version | jq -r '\''"9222\n/devtools/browser/" + (.webSocketDebuggerUrl | split("/") | .[-1])'\'' > "$HOME/personal-os-chrome-data/DevToolsActivePort"`

## OS Data

- We store all user preferences, data, and operations state in a private .git archive in `${HOME}/personal-os-data`
- This is organized as set of markdown files
- DO NOT store passwords or API keys in this archive
- Use worktrees when you need to modify in parallel and are running into issues
- Commit changes when you are complete with a task (if files modified)

## Scheduled Tasks

- `pos-cron add <name> <schedule> <prompt>` - schedule a recurring task
- `pos-cron list` - list all scheduled tasks
- `pos-cron rm <name>` - remove a scheduled task
- `pos-cron logs <name>` - tail logs for a task
- `pos-cron run <name>` - manually trigger a task
- Use cron even for event triggered tasks (task becomes: check if <condition> is met, if so, run <prompt>)
- Schedules: `daily@09:00`, `hourly`, `weekly@mon@09:00`

## Onboarding Mode

This means the personal-os-data directory is empty. Help the user set up their personal OS by:

1. First, use the AskUserQuestion tool to ask what level of detail they want to provide:
   - **Minimal**: Basic productivity tasks only (reminders, notes, simple automations)
   - **Standard**: Include preferences, goals, recurring tasks, and light personalization
   - **Comprehensive**: Full digital twin - detailed preferences, workflows, relationships, projects, health/fitness, finances, etc.
2. Based on their choice, use AskUserQuestion to gather relevant information and build out an INDEX.md file in the root of personal-os-data that serves as the central hub/table of contents for their personal OS.
3. The INDEX.md should link to other markdown files you create based on their needs (e.g., PROJECTS.md, PREFERENCES.md, GOALS.md, etc.)
4. Commit the initial setup when complete.

## Example Use Cases

When users describe problems, map them to capabilities. Each example shows: problem → solution (chrome/cron/bash/data) → context to gather.

- **"I forget to follow up after meetings"** → Store contacts in `CONTACTS.md` with context; `daily@08:00` cron checks for stale relationships, scrapes LinkedIn via chrome for recent activity, drafts personalized outreach. *Get: LinkedIn credentials in chrome profile, follow-up cadence preferences (7/14/30 days), VIP contacts list.*
- **"I waste money on forgotten subscriptions"** → Chrome scrapes bank transactions weekly, maintains `SUBSCRIPTIONS.md` with service/cost/last-used; cron flags unused services, calculates savings. *Get: Bank login in chrome, which subscriptions are essential vs optional, spending alert thresholds.*
- **"House listings sell before I see them"** → `hourly` cron scrapes Zillow/Redfin via chrome with filters from `HOUSE_SEARCH.md`, scores by commute/schools/price, urgent alerts for 8+/10 matches. *Get: Target neighborhoods, price range, must-haves vs nice-to-haves, work address for commute calc.*
- **"I read a lot but retain nothing"** → Log books/articles to `READING_LOG.md` with takeaways; `daily@07:30` cron serves spaced-repetition flashcards from entries >30 days old, tracks weak spots. *Get: Current reading sources (Kindle, Pocket, etc.), preferred review time, topics to prioritize.*
- **"I never know what to cook"** → Maintain `PANTRY.md` inventory + `RECIPES.md` favorites; `weekly@sun` cron checks grocery sales via chrome, generates meal plan using expiring ingredients first, outputs shopping list. *Get: Dietary restrictions, cuisine preferences, cooking skill level, grocery store for sales.*
- **"Job applications are exhausting"** → Master `RESUME.md` + criteria in `JOB_SEARCH.md`; `daily@09:00` cron finds matching jobs via chrome, scores fit, drafts tailored cover letters, tracks in `APPLICATIONS.md`, auto-drafts follow-ups after 7 days. *Get: Target roles/companies, salary range, resume PDF, LinkedIn URL, dealbreakers.*
- **"I keep falling off language learning"** → `SPANISH.md` tracks vocab + mastery scores; `daily@12:00` cron quizzes weak words, `daily@18:00` finds level-appropriate news via chrome with new vocab, weekly progress reports with streak tracking. *Get: Target language, current level, daily time commitment, learning goals (travel/work/fluency).*
- **"I lose track of investments"** → Chrome scrapes brokerage accounts daily, updates `INVESTMENTS.md`; compares to target allocation in `PORTFOLIO.md`, alerts when >5% drift, recommends rebalancing trades. *Get: All brokerage logins in chrome, target asset allocation percentages, risk tolerance, rebalancing frequency.*
- **"My side project never progresses"** → `PROJECTS.md` holds specs + next actions; `daily@20:00` cron analyzes git repo via bash, identifies smallest 15-min task, tracks completion; weekly reviews celebrate commits or probe blockers. *Get: Project repo path, available evening hours, what "done" looks like, current blockers.*
- **"I'\''m drowning in old files/notes"** → `weekly@sat` cron scans Downloads/Documents via bash, summarizes old files, proposes archive/delete; monthly consolidates orphaned notes, generates "state of knowledge base" report. *Get: Key directories to monitor, retention policies (30/60/90 days), archival location, files to never touch.*' \
    "$@" $( [ "$ONBOARDING_MODE" = "true" ] && echo "onboard" )